<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Time Logger</title>
    <style>
        /* CSS remains exactly as found in your file */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; color: #58a6ff; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 15px; background: #161b22; border: 2px solid #30363d;
            border-radius: 8px; color: #8b949e; cursor: pointer; text-align: center;
            font-weight: 600; transition: all 0.2s;
        }
        .tab.active { background: #238636; color: white; border-color: #238636; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-section {
            background: #161b22; padding: 20px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid #30363d;
        }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-group { flex: 1; margin-bottom: 15px; }
        label { display: block; color: #8b949e; font-size: 12px; margin-bottom: 5px; font-weight: 600; }
        input[type="date"], input[type="time"] {
            width: 100%; padding: 12px; font-size: 16px; background: #0d1117;
            border: 2px solid #30363d; border-radius: 8px; color: #e6edf3;
        }
        input[type="number"], input[type="text"] {
            width: 100%; padding: 15px; background: #0d1117;
            border: 2px solid #30363d; border-radius: 8px; color: #e6edf3;
        }
        .timer-section {
            background: #0d1117; padding: 20px; border-radius: 12px;
            margin-bottom: 15px; text-align: center; border: 2px solid #30363d;
        }
        .timer-display { font-size: 48px; font-weight: 700; color: #58a6ff; font-family: monospace; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { flex: 1; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; border: none; }
        .btn-start { background: #238636; color: white; }
        .btn-stop { background: #da3633; color: white; }
        .btn-add { background: #238636; color: white; }
        .btn-export { background: #1f6feb; color: white; }
        .btn-clear { background: #da3633; color: white; }
        .entries { background: #161b22; border-radius: 12px; padding: 20px; border: 1px solid #30363d; }
        .entry { background: #0d1117; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 3px solid #238636; }
        .total-section { background: #1f6feb; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .total-value { font-size: 32px; font-weight: 700; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è±Ô∏è Quick Time Logger</h1>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('logger')">üìù Logger</div>
            <div class="tab" onclick="switchTab('analysis')">üìä Analysis</div>
        </div>

        <div id="loggerTab" class="tab-content active">
            <div class="input-section">
                <div class="form-row">
                    <div class="form-group"><label>Work Date</label><input type="date" id="workDate"></div>
                    <div class="form-group"><label>Start Time</label><input type="time" id="startTime"></div>
                </div>
                <div class="timer-section">
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="btn-group">
                        <button class="btn-start" id="startBtn" onclick="startTimer()">‚ñ∂ Start Timer</button>
                        <button class="btn-stop" id="stopBtn" onclick="stopTimer()" disabled>‚èπ Stop Timer</button>
                    </div>
                </div>
                <div class="form-group"><label>Number</label><input type="number" id="numberInput"></div>
                <div class="form-group"><label>Note</label><input type="text" id="noteInput"></div>
                <div class="btn-group">
                    <button class="btn-add" onclick="addEntry()">‚ûï Add Entry</button>
                    <button class="btn-export" onclick="exportData()">üì• Export</button>
                    <button class="btn-clear" onclick="clearAll()">üóëÔ∏è Clear</button>
                </div>
            </div>
            <div class="entries" id="entriesContainer"></div>
            <div class="total-section"><div class="total-value" id="totalSum">0</div></div>
        </div>
    </div>

    <script>
        // --- INDEXED DB WRAPPER ---
        const dbName = "TimeLoggerDB";
        const storeName = "logs";

        function getDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = () => request.result.createObjectStore(storeName);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbGet(key) {
            const db = await getDB();
            return new Promise((resolve) => {
                const transaction = db.transaction(storeName, "readonly");
                const request = transaction.objectStore(storeName).get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        async function dbSet(key, value) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, "readwrite");
                transaction.objectStore(storeName).put(value, key);
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // --- APP LOGIC ---
        let entries = [];
        let sessions = [];
        let currentSession = null;
        let timerInterval = null;

        // Replaced window.storage.get with IndexedDB
        async function loadData() {
            try {
                const savedEntries = await dbGet('timeLoggerEntries');
                if (savedEntries) {
                    entries = JSON.parse(savedEntries);
                    renderEntries();
                }
                const savedSessions = await dbGet('timeLoggerSessions');
                if (savedSessions) {
                    sessions = JSON.parse(savedSessions);
                }
            } catch (e) {
                console.log('Error loading:', e);
            }
        }

        // Replaced window.storage.set with IndexedDB
        async function saveData() {
            try {
                await dbSet('timeLoggerEntries', JSON.stringify(entries));
                await dbSet('timeLoggerSessions', JSON.stringify(sessions));
            } catch (e) {
                console.error('Error saving:', e);
            }
        }

        function startTimer() {
            const workDate = document.getElementById('workDate').value;
            const startTime = document.getElementById('startTime').value;
            if (!workDate || !startTime) return alert('Select date and time');

            currentSession = { id: Date.now(), workDate, startTime, entries: [] };
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            let elapsed = 0;
            timerInterval = setInterval(() => {
                elapsed++;
                const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
                const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
                const s = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            if (currentSession) {
                sessions.push(currentSession);
                saveData();
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('timerDisplay').textContent = "00:00:00";
        }

        function addEntry() {
            const number = parseFloat(document.getElementById('numberInput').value);
            const note = document.getElementById('noteInput').value;
            if (isNaN(number)) return;

            const entry = { id: Date.now(), number, note, timestamp: new Date().toLocaleTimeString() };
            entries.push(entry);
            saveData();
            renderEntries();
            document.getElementById('numberInput').value = '';
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            container.innerHTML = entries.map(e => `
                <div class="entry">
                    <div><strong>${e.number}</strong> - ${e.timestamp}</div>
                    <div>${e.note}</div>
                </div>
            `).join('');
            document.getElementById('totalSum').textContent = entries.reduce((s, e) => s + e.number, 0).toFixed(2);
        }

        async function clearAll() {
            if (confirm('Clear everything?')) {
                entries = []; sessions = [];
                await saveData();
                renderEntries();
            }
        }

        loadData();
    </script>
</body>
</html>
